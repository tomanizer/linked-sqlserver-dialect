services:
  dev:
    build:
      context: .
      dockerfile: .devcontainer/Dockerfile
    volumes:
      - ./:/workspaces/linked-sqlserver-dialect:cached
    working_dir: /workspaces/linked-sqlserver-dialect
    command: sleep infinity
    depends_on:
      sql1:
        condition: service_healthy
      sql2:
        condition: service_healthy

  sql1:
    image: mcr.microsoft.com/mssql/server:2022-latest
    environment:
      ACCEPT_EULA: "Y"
      MSSQL_SA_PASSWORD: "YourStrong(!)Password1"
    ports:
      - "14331:1433"
    healthcheck:
      test:
        [
          "CMD-SHELL",
          "/opt/mssql-tools18/bin/sqlcmd -C -S localhost -U sa -P $$MSSQL_SA_PASSWORD -Q 'SELECT 1' || exit 1"
        ]
      interval: 5s
      timeout: 3s
      retries: 40

  sql2:
    image: mcr.microsoft.com/mssql/server:2022-latest
    environment:
      ACCEPT_EULA: "Y"
      MSSQL_SA_PASSWORD: "YourStrong(!)Password2"
    ports:
      - "14332:1433"
    healthcheck:
      test:
        [
          "CMD-SHELL",
          "/opt/mssql-tools18/bin/sqlcmd -C -S localhost -U sa -P $$MSSQL_SA_PASSWORD -Q 'SELECT 1' || exit 1"
        ]
      interval: 5s
      timeout: 3s
      retries: 40

  init:
    # Use the SQL Server image as a "tools" container because it includes
    # /opt/mssql-tools18/bin/sqlcmd and has stable tags.
    image: mcr.microsoft.com/mssql/server:2022-latest
    depends_on:
      sql1:
        condition: service_healthy
      sql2:
        condition: service_healthy
    volumes:
      - ./mssql:/mssql:ro
    environment:
      SA1_PASSWORD: "YourStrong(!)Password1"
      SA2_PASSWORD: "YourStrong(!)Password2"
    command: ["/bin/bash", "/mssql/init.sh"]


